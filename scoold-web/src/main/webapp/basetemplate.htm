##if($request.method == "POST") #stop #end
################# DEFINE MACROS ################################################
#macro(dayselect $class $name $selectday)
	<select class="$class" name="$name">
		#if($selectday == 0)  
			<option value="" selected="selected">$!{lang.get("day")} &nbsp;</option>
		#else
			<option value="">$!{lang.get("day")} &nbsp;</option>
		#end

		#foreach ($day in [1..31])
			#if($selectday != 0 && $day == $selectday)
				<option value="${day}" selected="selected">${day}</option>
			#else
				<option value="${day}">${day}</option>
			#end
		#end
	</select>
#end
#####################################
#macro(monthselect $class $name $selectmonth)
	<select class="$class" name="$name">
		#if($selectmonth == 0)
			<option value="" selected="selected">$!{lang.get("month")} &nbsp;</option>
		#else
			<option value="">$!{lang.get("month")} &nbsp;</option>
		#end

		#foreach ($month in $daoutils.getMonths($currentLocale))
			#if($velocityCount < 13)
				#if($selectmonth != 0 && $velocityCount == $selectmonth)
					<option value="$velocityCount"  selected="selected">${month} &nbsp;</option>
				#else
					<option value="$velocityCount" >${month} &nbsp;</option>
				#end
			#end
		#end
	</select>
#end
#####################################
#macro(yearselect $class $name $future $selectyear $firstItem)
	<select class="$class" name="$name">
		#if($firstItem && $firstItem == "") #set($first = $!lang.get("year"))
		#else	#set($first = $firstItem)	#end

		#if($selectyear == 0)
			<option value="" selected="selected">$first &nbsp;</option>
		#else
			<option value="">$!{lang.get("year")} &nbsp;</option>
		#end

		#if($future)  #set($y1 = $daoutils.currentYear + 10) #set($y2 = $y1 - 80)
		#else  #set($y1 = $daoutils.currentYear)  #set($y2 = $y1 - 65)  #end

		#foreach ($y in [$y1..$y2])
			#if($selectyear != 0 && $selectyear == $y)
			<option value="${y}" selected="selected">${y}</option>
			#else
			<option value="${y}">${y}</option>
			#end
		#end
	</select>
#end
#####################################
#macro(renderSpecialFields $clickform)
	${clickform.fields.form_name}
	#foreach ($field in $clickform.fieldList)
		#if ($field.name.contains("SUBMIT_CHECK")) $field #end
	#end
#end
#####################################
#macro(getcontactlinkcode $showcontact)
	#if($showcontact)
		#if($showcontact.value.startsWith("http://") || $showcontact.value.startsWith("https://") || $showcontact.value.startsWith("www."))
			<a href="$showcontact.value" class="extlink" rel="no-follow">$!showcontact.value</a>
		#elseif($showcontact.type == "SKYPE")
			<a href="skype:$!showcontact.value?add" rel="no-follow">$!showcontact.value</a>
		#elseif($showcontact.type == "AIM")
			<a href="aim:goim?screenname=$!showcontact.value" rel="no-follow">$!showcontact.value</a>
		#elseif($showcontact.type == "YAHOO")
			<a href="ymsgr:addfriend?$!showcontact.value" rel="no-follow">$!showcontact.value</a>
		#elseif($showcontact.type == "GTALK")
			<a href="gtalk:chat?jid=$!showcontact.value" rel="no-follow">$!showcontact.value</a>
		#elseif($showcontact.type == "TWITTER")
			#if($showcontact.value.startsWith("@"))
				#set($showcontval = $showcontact.value.substring(1))
				<a href="http://twitter.com/$!showcontval">@$!showcontval</a>
			#else
				<a href="http://twitter.com/$!showcontact.value">@$!showcontact.value</a>
			#end
		#else
			$!showcontact.value
		#end
	#end
#end
#####################################
#macro(contactdetailtypestr $detailtype )
	#if($detailtype.name() == "WEBSITE") #set($showdetailstr = $!lang.get("website") )
	#elseif($detailtype.name() == "ADDRESS") #set($showdetailstr = $!lang.get("address") )
	#elseif($detailtype.name() == "UNKNOWN") #set($showdetailstr = $!lang.get("unknown") )
	#else #set($showdetailstr = $detailtype.toString() ) #end
	$!showdetailstr
#end
#####################################
#macro(contactdetailbox $showdetail )
	#if($showdetail == "")
		#set($hide = "hide" )
	#else
		#set($hide = "" )
	#end
	
	<tr class="detailbox $hide">
		<td class="r p25 contact-type">#contactdetailtypestr($showdetail.getContactDetailType()):</td>
		<td class="pll p75">
			<span class="contact-value">$!detail.value</span>
			<input type="hidden" name="contacts" value="$!detail"/>
			<a href="#" class="pictos remove-contact" title="$!lang.get('remove')">D</a>
		</td>
	</tr>
#end
#####################################
#macro(showaboutview )
	<table class="p100">
		<tbody>
			#if($showUser.rawDobString && !$showUser.rawDobString.isEmpty())
			<tr>
				<td class="r p25">$!{lang.get("profile.about.age")}: </td>
				<td class="pll p75" title="#formatdate($!{showUser.dob} 'dd MMMM yyyy')">$!{showUser.age} </td>
			</tr>
			#end
			#if($showUser.location && !$showUser.location.isEmpty())
			<tr>
				<td class="r p25">$!{lang.get("profile.about.location")}:</td>
				<td class="pll p75">$!{showUser.location}</td>
			</tr>
			#end
			#if($showUser.ilike && !$showUser.ilike.isEmpty())
			<tr>
				<td class="r p25">$!{lang.get("profile.about.ilike")}:</td>
				<td class="pll p75">$!{showUser.ilike}</td>
			</tr>
			#end
			#if($showUser.contacts && !$showUser.contacts.isEmpty())
				#foreach($contact in $showUser.getAllContactDetails())
				<tr>
					<td class="r p25">$!lang.get(${contact.type.toLowerCase()}):</td>
					<td class="pll p75">#getcontactlinkcode($!contact)</td>
				</tr>
				#end
			#end
			#if($showUser.aboutme && !$showUser.aboutme.isEmpty())
			<tr>
				<td class="r p25">$!{lang.get("profile.about.aboutme")}:</td>
				<td class="pll p75">$!{showUser.aboutme}</td>
			</tr>
			#end
			#if($showUser.timestamp)
			<tr>
				<td class="r p25">$!{lang.get("profile.about.membersince")}:</td>
				<td class="pll p75">#formatdate($!{showUser.timestamp} "dd MMMM yyyy")</td>
			</tr>
			#end
			#if($showUser.lastseen)
			<tr>
				<td class="r p25">$!{lang.get("profile.about.lastseen")}:</td>
				<td class="pll p75">#formatdate($!{showUser.lastseen} "")</td>
			</tr>
			#end
		</tbody>
	</table>
#end
################# SCHOOL MACROS #####################
#macro(myschoolspage $schools )
	#foreach($school in $schools)
		#myschoolbox($school)
	#end
#end
#####################################################
#macro(myschoolbox $schools )
	<div class="editschool">
		#if($request.getParameter("edit"))
			#set($hideedit = "")
			#set($hideview = "hide")
		#else
			#set($hideedit = "hide")
			#set($hideview = "")
		#end

		<div class="viewbox $hideview">
			#schoolbox($school true)
		</div>

		#if($canEdit)
			<div class="editbox lightgraybg rounded5 mvl pam $hideedit">
				<form method="post" class="school-edit-form" action="$profilelink/$!showUser.id">
					<fieldset>
						#sectoken(false)
						<input type="hidden" name="sid" value="$!school.id"/>
						<input type="hidden" name="getmyschoolscode" value="true"/>

						<legend>$!{lang.get("profile.myschools.add.period")}:</legend>
						<div class="line">
							<div class="unit size1of2">
								<label class="mrm">$!{lang.get("from")}</label>
								#yearselect("fromyear nicebox p60" "fromyear" false $!school.fromyear "")
							</div>
							<div class="unit size1of2 lastUnit">
								<label class="mrm">$!{lang.get("to")}</label>
								#yearselect("toyear nicebox p60" "toyear" true $!school.toyear "")
							</div>
						</div>

						<div class="center mtl">
							<input type="submit" value="$!{lang.get('save')}" class="edit-schoolbtn button rounded3"/>
							<input type="button" value="$!{lang.get('close')}" class="button rounded3 canceledit $hideview"/>
						</div>
					</fieldset>
				</form>
			</div>
		#end
	</div>
#end
#####################################
#macro(schoolaboutview )
	#if(!$showSchool.about || $showSchool.about.trim().isEmpty() && $canEdit)
		<a class="editlink info-placeholder largeText center inlineblock p100 rounded5 mbl" href="$schoollink/$showSchool.id/edit">$!lang.get("clickedit")</a>
	#else
		<p>$!showSchool.about</p>
	#end
	<table class="p100">
		<tbody>	
			#if($showSchool.contacts && !$showSchool.contacts.isEmpty())
				#foreach($contact in $showSchool.getAllContactDetails())
				<tr>
					<td class="r p25">$!lang.get(${contact.type.toLowerCase()}):</td>
					<td class="pll p75">#getcontactlinkcode($!contact)</td>
				</tr>
				#end
			#end
			<tr>
				<td class="r p25">$!{lang.get("school.created")}:</td>
				<td class="pll p75" colspan="2">#formatdate($!showSchool.timestamp "dd MMMM yyyy")</td>
			</tr>
		</tbody>
	</table>
#end
################# MESSAGES MACROS #####################
#macro(newmessageform $names $ids)
	<form method="post" class="new-message-form" action="$messageslink/new">
		<fieldset class="p98 mtl">
			#sectoken(false)
			#if($names.size() == 0)
				#set($toval = "")
			#else
				#foreach($showname in $names)
					#set($toval = "$!toval, $showname" )
				#end
				#set($toval = $toval.substring(2, $toval.length()))
			#end
			<table>
				<tbody>
					<tr>
						<th class="prm">$!lang.get("messages.to"):</th>
						<td class="p100">
							<input type="text" name="to" class="contactnamebox nicebox p100 mbm" value="$!toval"/>
							<input type="hidden" name="toids" value=""/>
							<!--<input type="text" class="nicebox p90" value="$tonames"/>-->
							#foreach($id in $ids)
								<input type="hidden" name="toid" value="$id"/>
							#end
						</td>
					</tr>
					<tr>
						<th class="prm">$!lang.get("message.title"):</th>
						<td class="p100"><textarea rows="3" cols="4" class="p100 nicebox" name="body"></textarea></td>
					</tr>
				</tbody>
			</table>
			
			<div class="center mtl">
				<input type="submit" value="$!lang.get('send')" id="sendmessage-btn" class="button rounded3 mrm"/>
				<input type="button" value="$!lang.get('close')" id="sendmessage-close" class="button rounded3 mlm"/>
			</div>
		</fieldset>
	</form>
#end
################# COMMENTS MACROS #####################
#macro(newcommentform $parentid $hidden $uri)
	#if($uri == "")
		#set($thisuri = $request.getAttribute('javax.servlet.forward.request_uri'))
		#if($request.getParameter('javax.servlet.forward.query_string'))
			#set($thisuri = "$!{thisuri}?$!request.getAttribute('javax.servlet.forward.query_string')")
		#end
	#else
		#set($thisuri = $uri)
	#end

	#if($hidden) #set($hide = "hide") #else	#set($hide = "") #end
	<div class="newcommentform mvm $hide">
		<form method="post" class="new-comment-form" action="${thisuri}">
			<fieldset>
				#sectoken(false)
				<div class="line">
					<div class="unit size4of5">
						<textarea rows="2" cols="4" class="p100 nicebox" name="comment"></textarea>
						<input type="hidden" name="parentid" value="$!parentid"/>
						<input type="hidden" name="getcommenthtmlcode" value="true"/>
					</div>
					<div class="unit size1of5 lastUnit center">
						<input type="submit" value="$!lang.get('add')" class="button rounded3 new-comment-btn"/>
					</div>
				</div>
			</fieldset>
		</form>
	</div>
#end
################# QUESTIONS MACROS #####################
#macro(newquestionform $form $hidden $type)
	#set($thisuri = $request.getAttribute('javax.servlet.forward.request_uri'))

	#if($hidden) #set($hide = "hide") #else #set($hide = "") #end
	#if($type.equalsIgnoreCase("question"))
		<h2>
			#if($postParentId && $postParentClass)
				#if($postParentClass == "school")
					#set($actionlink = "$schoollink/$!postParentId")
					<a href="$actionlink">$!lang.get("school.title")</a>
				#elseif($postParentClass == "group")
					#set($actionlink = "$grouplink/$!postParentId")
					<a href="$actionlink">$!lang.get("group.title")</a>
				#end
			#else
				#set($actionlink = $questionslink)
				<a href="$actionlink">$!lang.get("questions.title")</a>
			#end
			/ #if($postParentClass == "group") $!lang.get("posts.new") #else $!lang.get("posts.ask") #end
		</h2>
	#elseif($type.equalsIgnoreCase("feedback"))
		#set($actionlink = $feedbacklink)
		<h2><a href="$feedbacklink">$!lang.get("feedback.title")</a> / $!lang.get("feedback.write")</h2>
	#end
	<hr />
	<div id="questionform" class="qform $hide">
		<form method="post" id="$form.id" action="$thisuri">
			#if ($form.error)
				#getmessagebox("errorBox" $form.error false)
			#end
			<fieldset>
				#sectoken(false)
				#renderSpecialFields($form)
				${form.fields.timer}
				<div class="hide">Leave blank:</div>${form.fields.additional}
				<input type="hidden" name="ask" value="true"/>
				#createformfield(${form.fields.parentid} "nicebox p50")
				#createformfield(${form.fields.title} "nicebox p98")
				#createformfield(${form.fields.body} "edit-post nicebox p98 nicebox hidelabel")
				<div class="edit-preview"></div>
				#createformfield(${form.fields.tags} "tagbox nicebox p98")

				<div class="center mtl">
					${form.fields.askbtn} &nbsp; <a href="$!actionlink" class="button-small rounded3">$!lang.get('cancel')</a>
				</div>
			</fieldset>
		</form>
	</div>
#end
###########################################
#macro(newanswerform $form $showpost $hidden)
	#set($thisuri = $request.getAttribute('javax.servlet.forward.request_uri'))

	#if($hidden) #set($hide = "hide") #else #set($hide = "noclass") #end
	<div class="$hide">
		<form method="post" id="$form.id" action="$thisuri">
			#if($form.error)
				#getmessagebox("errorBox" $form.error false)
			#end
			<fieldset>
				#sectoken(false)
				#if($showpost.isQuestion())
					<legend>$!lang.get("posts.youranswer")</legend>
				#else
					<legend>$!lang.get("feedback.writereply")</legend>
				#end
				#renderSpecialFields($form)
				${form.fields.timer}
				<input type="hidden" name="answer" value="true"/>
				<div class="hide">Leave blank:</div>${form.fields.additional}
				<ol>
					<li>
						#createformfield(${form.fields.body} "hidelabel edit-post unload-confirm p99 nicebox")
						<div class="edit-preview"></div>
					</li>
				</ol>

				<div class="center">
					${form.fields.answerbtn}
					<input type="button" value="$!lang.get('close')" class="button rounded3 close-answer-form"/>
				</div>
			</fieldset>
		</form>
	</div>
#end
###########################################
#macro(tagsbox $tags $link)
	#foreach($showtag in $tags.split(","))
		#if($showtag && $showtag.trim() != "")
			#if($link.isEmpty())
				<span class="button-tiny rounded3 mrs">
					<span class="pictos">z</span> $!showtag
				</span>
			#else
				<a href="$link/tag/$!daoutils.urlEncode($showtag)" title="Posts tagged $!showtag" class="button-tiny rounded3 mrs">
					<span class="pictos">z</span> $!showtag
				</a>
			#end
		#end
	#end
#end
################# PHOTOS MACROS #####################
#macro(showphotos $baseurl $canedit)
	#if($request.getParameter("label"))
		#set($showlabel = $request.getParameter("label"))
		#if(!$showlabel.isEmpty()) #set($labelparam = "/?label=$daoutils.urlEncode($showlabel)") #else #set($labelparam = "") #end
		<h2><a href="${baseurl}">$!lang.get("photos.title")</a> / <a href="${baseurl}${labelparam}"><span class="pictos">z</span> $!{showlabel} #showcount($mediacount.longValue())</a> / $!lang.get("photos.gallery")</h2>
	#else
		#set($showlabel = "")
		<h2><a href="${baseurl}">$!lang.get("photos.title")</a> / $!lang.get("photos.gallery") #showcount($mediacount.longValue()) <a href="#" class="pictos trigger-embedly-services">?</a></h2>
	#end

	#if($showlabel != "")
		#set($labelparam = "label=$showlabel")
	#else
		#set($labelparam = "")
	#end

	#if($request.getParameter("mid"))
		#gallery($medialist $baseurl $mediacount.longValue())
	#else
		#if($canedit)
			#oembedbox("addimage")
		#end
		<div id="photos" class="mvl">
			#paginate($pagenum.longValue() "\#thumbspage(\$medialist \$showlabel)" $mediacount.longValue() "$labelparam" "pageless" )
		</div>
		<br />
		#showlabels($labelslist $baseurl)
	#end
#end
####################################
#macro(thumbbox $thumb $showlabel)
	<div class="thumb-wrap center inlineblock mrl">
		#set($turl = $request.getAttribute("javax.servlet.forward.request_uri"))
		#set($delturl = "${turl}/?remove=$!thumb.id&amp;parentid=$!thumb.parentid")
		#if($showlabel && !$showlabel.isEmpty())
			#set($label = "?label=${showlabel}&amp;mid=")
			#set($delturl = "${delturl}&amp;label=${showlabel}")
		#else
			#set($label = "?mid=")
		#end
		<div>
			<a class="thumb" href="${turl}${label}${thumb.id}" title="$!thumb.title" >
				#if($thumb.thumburl && !$thumb.thumburl.isEmpty())
					<img src="$!thumb.thumburl" alt="$!thumb.title" title="$!thumb.description" class="rounded3"/>
				#else
					<img src="$!thumb.url" alt="$!thumb.title" title="$!thumb.description" class="rounded3 oembed-thumb"/>
				#end
			</a>
		</div>
		<div>
			#if(($authenticated && ($thumb.userid == $authUser.id) || $request.isUserInRole("mod")))
				<a href="${delturl}" title="Delete photo" class="image-delete red button-tiny rounded3">
					<span class="pictos">*</span>
				</a>
			#else
				#getreportlink($thumb "${turl}/${label}$!{thumb.id}" "button-tiny rounded3 notext")
			#end
		</div>
	</div>
#end
####################################
#macro(thumbspage $thumbs $showlabel)
	#set($page = $pagenum.longValue())
	#if($showlabel && !$showlabel.isEmpty())
		#set($showlabel = $daoutils.urlEncode($showlabel))
	#else
		#set($showlabel = "")
	#end

	#foreach($thumb in $thumbs)
		#thumbbox($thumb $showlabel)
	#end
#end
###########################################
#macro(showlabels $labels $url)
	#if($labels && !$labels.isEmpty())
		<div>
			<h2>$!lang.get("photos.labels")</h2>
			
			#foreach($labelshow in $labels)
				#labelbox($labelshow $url "" false)
			#end
		</div>
	#end
#end
###########################################
#macro(labelbox $labelshow $url $mid $showx )
	#if($labelshow == "") 
		#set($hide = "hide" ) 
		#set($labelclass = "empty-label" )
		#set($lboxclass = "hide" )
		#set($showlabelenc = "" )
	#else 
		#set($hide = "" )
		#set($labelclass = "noclass" )
		#set($lboxclass = "button-tiny" )
		#set($showlabelenc = $daoutils.urlEncode($labelshow) )
	#end
	
	<span class="labelbox rounded3 mrs $!lboxclass">
		<span class="pictos">z</span>
		<a href="${url}?label=$!{showlabelenc}" class="$!labelclass" title="$!labelshow">$!labelshow</a>
		#if($showx)
			<a href="${url}?mid=$!{mid}&amp;removelabel=$!{showlabelenc}" title="Remove label" class="remove-label"><span class="pictos">D</span></a>
		#end
	</span>
#end
###########################################
#macro(gallery $photos $gurl $totalCount)
	<script type="text/javascript">
		allLabels = [#foreach($lbl in $labelslist)#if($lbl && !$lbl.isEmpty())"$!lbl"#end#if($velocityCount < $labelslist.size()),#end#end];
	</script>

	#set($showlabel = $!request.getParameter("label"))
	#set($startIndex = $startIndex.parseInt($request.getParameter("mid")))
	#if(!$showlabel.isEmpty()) 
		#set($label = "?label=$daoutils.urlEncode($showlabel)&amp;mid=")
	#else
		#set($label = "?mid=")
	#end
	
	#if($photos && !$photos.isEmpty())
		#set($prevIndex = $photos.get(1).id)
		#set($nextIndex = $photos.get(2).id)
		#set($currentPhoto = $photos.get(0))

		#if(!$showlabel.isEmpty()) #set($labelparam = "/?label=$daoutils.urlEncode($showlabel)") #else #set($labelparam = "") #end
		<div id="gallery" class="content mtl">
			<div id="controls" class="controls mbm line">
				<div class="nav-controls unit size1of2 ptm">
					<a class="prev button-small rounded3 mrs" href="${gurl}/$!{label}$!{prevIndex}" title="Previous">&nbsp;<span class="pictos">[</span>&nbsp;</a>
					<a class="next button-small rounded3 mls" href="${gurl}/$!{label}$!{nextIndex}" title="Next">&nbsp;<span class="pictos">]</span>&nbsp;</a>
				</div>
				<div class="unit size1of2 lastUnit r">
					#votebox($currentPhoto "largeText")
				</div>
			</div>
			<div class="slideshow-container center">
				<div id="slideshow" class="slideshow">
					<a class="advance-link" href="${gurl}/$!{label}$!{nextIndex}" title="$!lang.get('next')">
						#set($sizearr = $daoutils.getMaxImgSize($currentPhoto.height, $currentPhoto.width) )
						<img height="$sizearr.get(0)" width="$sizearr.get(1)" src="$currentPhoto.url" alt="$!currentPhoto.title" class="rounded3"/>
					</a>
					<div id="caption" class="caption-container">
						<span class="image-title">$!currentPhoto.title</span>
						<span class="image-caption">$!currentPhoto.description</span>
						#if(($authenticated && $currentPhoto.userid == $authUser.id) || $request.isUserInRole("mod"))
							<span class="image-original">
								#if($currentPhoto.originalurl)
									<a href="$!currentPhoto.originalurl" title="View original" class="extlink">$!lang.get("photos.vieworiginal")</a>
								#end
							</span>
						#end
					</div>

					<div class="mbs">
						<span id="labels" class="labels-container">
							#foreach($l in $currentPhoto.getLabelsSet())
								#labelbox($l $gurl $currentPhoto.id true)
							#end
							#labelbox("" $gurl $currentPhoto.id true)
						</span>

						<a href="#" title="Add label" class="next-div-toggle button-tiny rounded3"><span class="pictos">&amp;</span> $!lang.get("photos.addlabels")</a>
						<div class="hide mtm">
							<form method="post" id="add-label-form" action="$gurl">
								<fieldset>
									#sectoken(false)
									<input type="text" class="addlabelbox nicebox p60" value="" name="addlabel"/>
									<input type="hidden" name="mid" value="$currentPhoto.id"/>
									<input type="submit" value="$!lang.get('add')" class="button rounded3"/>
								</fieldset>
							</form>
						</div>
					</div>
				</div>
			</div>
		</div>

		<div class="comments p100 mtl">
			#paginate($pagenum.longValue() "\#commentspage(\$commentslist)" $itemcount.longValue() "mid=$!{currentPhoto.id}&amp;parentid=$!{currentPhoto.id}" "pageless" )
		</div>
		
		<div class="center mtl">
			#if($authenticated && $canComment)
				#if($request.getParameter("write")) #set($hidebox = false) #else #set($hidebox = true)	#end
				<a href="${gurl}/$!{label}$!{currentPhoto.id}?write=true" class="button-small rounded3 next-div-toggle" title="Add a comment">$!lang.get("comments.write")</a>
				#newcommentform($currentPhoto.id $hidebox "")
			#end
		</div>
	#end
#end
################# DRAWER MACROS #####################
#macro(oembedbox $btnclass)
	#set($uri = $request.getAttribute("javax.servlet.forward.request_uri"))
	<div id="embedly-services" class="jqmWindow rounded5">
		<a href="http://embed.ly" class="extlink right">
			<img src="http://embed.ly/static/images/logos/embedly-powered-small-light.png" alt="embedly"/>
		</a>
		<span class="mediumText">$!lang.get("profile.drawer.embedly")</span>
		#ajaxloading(false)
		<div class="mtl"></div>
		<div class="center mtl">
			<a href="#" class="jqmClose button-small rounded3">$!lang.get("close")</a>
		</div>
	</div>
	<form method="post" id="embed-form" action="${uri}">
		<fieldset>
			#sectoken(false)
			<input type="text" value="$!lang.get('profile.drawer.share')" name="url" class="nicebox hintbox p90"/>
			<input type="hidden" name="getmediahtmlcode" value="true"/>
			<a href="#" class="button-small rounded3 mls $btnclass"><span class="pictos">&amp;</span></a>
			
			<div class="red embed-error"></div>
			<div class="hide oembed-preview pam center mtm rounded5">
				#ajaxloading(false)
				<div id="oembed-container" class="center">	</div>
				<input type="submit" value="$!lang.get('add')" id="embed-btn" class="button rounded3"/>
				&nbsp;
				<a href="#" class="cancel-embed-btn" title="$!lang.get('close')">$!lang.get("close")</a>
			</div>
		</fieldset>
	</form>	
#end
################# PAGINATION #####################
#macro(paginate $page $macroCode $count $params $mode)
	#if($pagenum.longValue() > 10000) #set($next = $page) #else #set($next = $page + 1) #end
	#set($requri = $request.getAttribute("javax.servlet.forward.request_uri"))
	#set($classes = "pagelink button-small rounded3")
	#if($params && !$params.isEmpty()) #set($reqURL = "$requri?${params}&amp;page") #else #set($reqURL = "$requri?page") #end
	
	<div class="page-content">#evaluate($macroCode)</div>
	#if($count > $MAX_ITEMS_PER_PAGE && $macroCode && !$macroCode.trim().isEmpty())
		<div class="pages center mtl">
			#if($mode == "pageless") #set($classes = "$classes more-link" ) #else #set($classes = "$classes more-link-na" ) #end
			<a href="$reqURL=$!next" class="more-link-na $classes" title="Load more">$!lang.get("more")</a>
			<span class="hide page-macro-code">$!macroCode</span>
		</div>
	#end
#end
####################################
#macro(schoolbox $showschool $showYears)
	<div class="whitebox clearfix media">
		<div class="img mrl ">
			#if($showschool.iconurl && !$showschool.iconurl.isEmpty())
				#set($schoolthumbclass = "noclass" )	
			#else
				#set($schoolthumbclass = "school-pic-thumb inlineblock" )
			#end
			
			<a href="$schoollink/$!showschool.id/#stripstr($!showschool.name)" class="$schoolthumbclass">
				#if($showschool.iconurl && !$showschool.iconurl.isEmpty())
					<img src="$showschool.iconurl" alt="School thumbnail" />
				#else
					&nbsp;
				#end
			</a>
		</div>
		<div class="bd">
			<div class="line lightgray">
				<div class="unit size1of2">$!lang.get("school.${showschool.type}")</div>
				<div class="unit size1of2 lastUnit r">
					<span>$!showschool.location</span>
				</div>
			</div>
			<div class="line">
				<div class="unit size3of4">
					<div class="mediumText">
						<span class="phs rounded3 reputationbox" title="$!lang.get('votes')">$daoutils.abbreviateInt($!showschool.votes, 0)</span>
						<a href="$schoollink/$!showschool.id/#stripstr($!showschool.name)" >$!{showschool.name}</a>
					</div>
					#if($showschool.fromyear && $showschool.fromyear != 0)
					#set($from = $showschool.fromyear) #else #set($from = "") #end

					#if($showschool.toyear && $showschool.toyear != 0)
					#set($to = $showschool.toyear) #else #set($to = "") #end

					#if($from != "" && $showYears)
						<span class="mediumText eduperiod ">$from - $to</span>
					#end
				</div>
				<div class="unit size1of4 lastUnit r">
					#if($authenticated)
						#if($showschool.isLinkedTo($authUser))
							<a class="button-tiny rounded3" href="$schoollink/$!showschool.id/leave/#stripstr($!showschool.name)" class="rounded3 button-tiny rusure">
								<span class="pictos">-</span> $!lang.get("leave")
							</a>
						#else
							<a class="button-tiny rounded3" href="$schoollink/$!showschool.id/join/#stripstr($!showschool.name)" class="rounded3 button-tiny">
								<span class="pictos">+</span> $!lang.get("join")
							</a>
						#end
					#end
					#if($canEdit)
						<a href="$profilelink/$!showUser.id/schools/edit" class="editlink button-tiny rounded3">
							<span class="pictos">W</span> $!lang.get("edit")
						</a>
					#end
					#if(!$authenticated || ($authenticated && $showschool.userid != $authUser.id))
						#getreportlink($showschool "$schoollink/$!showschool.id" "button-tiny rounded3 notext")
					#end
				</div>
			</div>
		</div>
	</div>
#end
####################################
#macro(schoolspage $schools)
	#foreach($showschool in $schools)
		#schoolbox($showschool false)
	#end
#end
####################################
#macro(classbox $showclass )
	<div class="whitebox clearfix classbox media">
		<div class="img center mls mrl">
			<div class="lightgray">$!lang.get("year")</div>
			<span class="hugeText">$!{showclass.gradyear}</span>
		</div>
		<div class="bd">
			#set($showschool = $showclass.school)
			<div class="line lightgray">
				<div class="unit size1of3">$!lang.get("class.title")</div>
				<div class="unit size2of3 lastUnit r" title="$!lang.get('class.classmates')">
					<span class="pictos">g</span> $!showclass.count
				</div>
			</div>
			<div class="line">
				<div class="unit size3of4">
					<div class="mediumText">
						<a href="$classlink/$!showclass.id/#stripstr($!showclass.identifier)">$!{showclass.identifier}</a>
					</div>
					<span class="pictos">j</span> <a href="$schoollink/$!showschool.id/#stripstr($!showschool.name)">$!{showschool.name}</a>
				</div>
				<div class="unit size1of4 lastUnit r">
					#if($authenticated)
						#if($showclass.isLinkedTo($authUser))
							<a class="button-tiny rounded3" href="$classlink/$!showclass.id/leave/#stripstr($!showclass.identifier)/?left=true">
								<span class="pictos">-</span> $!lang.get("leave")
							</a>
						#else
							<a class="button-tiny rounded3" href="$classlink/$!showclass.id/join/#stripstr($!showclass.identifier)/?joined=true">
								<span class="pictos">+</span> $!lang.get("join")
							</a>
						#end
					#end
					#if(!$authenticated || ($authenticated && $showclass.userid != $authUser.id))
						#getreportlink($showclass "$classlink/$showclass.id" "button-tiny rounded3 notext")
					#end
				</div>
			</div>
		</div>
	</div>
#end
####################################
#macro(classespage $classes)
	#foreach($showclass in $classes)
		#classbox($showclass)
	#end
#end
###################################
#macro(classmatespage $classmates)
	#foreach($classmate in $classmates)
		#smallpersonbox($classmate)
	#end
#end
####################################
#macro(groupbox $showgroup )
	<div class="whitebox clearfix groupbox media">
		<div class="img center mls mrl">
			#grouppic($showgroup "small")
		</div>
		<div class="bd">
			<div class="line lightgray">
				<div class="unit size1of3">$!lang.get("group.title")</div>
				<div class="unit size2of3 lastUnit r" title="$!lang.get('group.members')">
					<span class="pictos">g</span> $!showgroup.count
				</div>
			</div>
			<div class="line">
				<div class="unit size3of4">
					<div class="mediumText">
						<a href="$grouplink/$!showgroup.id/#stripstr($!showgroup.name)">$!{showgroup.name}</a>
					</div>
					#if($showgroup.description && !$showgroup.description.trim().isEmpty())
						<span>$showgroup.description</span>
					#end
				</div>
				<div class="unit size1of4 lastUnit r">
					#if($authenticated)
						#if($showgroup.isLinkedTo($authUser) && !$showgroup.userid.equals($authUser.id))
							<a class="button-tiny rounded3" href="$grouplink/$!showgroup.id/leave/#stripstr($!showgroup.name)/?left=true">
								<span class="pictos">-</span> $!lang.get("leave")
							</a>
						#end
					#end
					#if(!$authenticated || ($authenticated && $showgroup.userid != $authUser.id))
						#getreportlink($showgroup "$grouplink/$showgroup.id" "button-tiny rounded3 notext")
					#end
				</div>
			</div>
		</div>
	</div>
#end
####################################
#macro(grouppic $showgroup $large)
	#set($hasimg = $showgroup.imageurl && $showgroup.imageurl.startsWith("http") && 
		!$showgroup.imageurl.contains("scoold.com"))
	#if($large && $large == "large")
		#if($hasimg)
			<img src="$!showgroup.imageurl" alt="Group image" class="rounded3 profile-pic-large"/>
		#else
			<span class="gigaText pictos groupicon-large rounded3">g</span>
		#end
	#else
		#if($hasimg)
			<img src="$!showgroup.imageurl" alt="Group image" class="profile-pic-small"/>
		#else
			<span class="mediumText pictos groupicon-small">g</span>
		#end
	#end
#end
####################################
#macro(groupspage $groups)
	#foreach($showgroup in $groups)
		#groupbox($showgroup)
	#end
#end
####################################
#macro(groupmemberspage $members)
	#set($uri = $request.getAttribute("javax.servlet.forward.request_uri"))
	#foreach($showmember in $members)
		#if($showmember.id.equals($authUser.id))
			#set($showmember.isGroupMember = false )
		#else
			#set($showmember.isGroupMember = true )
		#end
		#personbox($showmember)
	#end
#end
####################################
#macro(personbox $showFriend)
	#if($showFriend)
		<div class="whitebox clearfix media">
			<div class="img mrl center">
				<a href="$profilelink/$showFriend.id/#stripstr($showFriend.fullname)">
					<img src="#profilepic($showFriend true)" width="50" height="50" alt="Profile thumbnail"/>
				</a>
			</div>
			<div class="bd">
				<div class="line lightgray">
					<div class="unit size1of2">$!{lang.get($showFriend.type)}</div>
					<div class="unit size1of2 lastUnit r">
						#usertitlebadge($showFriend)					
					</div>
				</div>
				<div class="line">
					<div class="unit size3of4">
						<div class="mediumText mbs">
							<span class="phs rounded3 reputationbox" title="$!lang.get('reputation')">$daoutils.abbreviateInt($!showFriend.reputation, 0)</span>
							<a href="$profilelink/${showFriend.id}/#stripstr($!showFriend.fullname)">$!{showFriend.fullname}</a>
						</div>
						#if($showFriend.status && !$showFriend.status.isEmpty() && !$showFriend.isGroupMember)
							<div>$!{showFriend.status}</div>
						#end
					</div>
					<div class="unit size1of4 lastUnit r">
						#if($showFriend.isGroupMember)
							<a href="${uri}?remove=$showmember.id" class="remove-groupmember-btn button-small rounded3"><span class="pictos">_</span> $!lang.get("remove")</a>
						#else
							#if($authenticated && $authUser.id != $showFriend.id)
								#if($authUser.isFriendWith($showFriend))
									<a class="delfriend button-tiny rounded3" href="$profilelink/$!{showFriend.id}/remove" title="Remove from contacts">
										<span class="pictos">-</span> $!{lang.get("remove")}
									</a>
								#else
									<a class="addfriend button-tiny rounded3" href="$profilelink/$!{showFriend.id}/add" title="Add to contacts">
										<span class="pictos">+</span> $!lang.get("add")
									</a>
								#end
							#end
							#if(!$authenticated || ($authenticated && $showFriend.id != $authUser.id))
								#getreportlink($showFriend "$profilelink/$showFriend.id" "button-tiny rounded3 notext")
							#end
						#end
					</div>
				</div>
			</div>
		</div>	
	#end
#end
####################################
#macro(smallpersonbox $showu)
	<div id="user-$!{showu.id}" class="userbox media pas inlineblock">
		<div class="img mrm center">
			#if($showu)
				<a href="$profilelink/$!showu.id/#stripstr($!showu.fullname)" title="$!showu.fullname">
					<img src="#profilepic($!showu true)" width="50" height="50" alt="Profile picture"/>
				</a>
			#else
				<img src="#profilepic($!showu true)" width="50" height="50" alt="Profile picture"/>
			#end
		</div>
		<div class="bd">
			#if($showu)
				<a href="$profilelink/$!showu.id/#stripstr($!showu.fullname)" class="smallText">$showu.fullname</a>
			#else
				$!lang.get("profile.deleted")
			#end
			#if($showu)
				<br />
				<span class="reputationbox rounded3 phs">$!daoutils.abbreviateInt($!showu.reputation, 0)</span>
				<span class="lightgray">#usertitlebadge($showu)</span>
			#end
		</div>
	</div>
#end
####################################
#macro(tinypersonbox $showu)
	<div class="inlineblock">
		#if($showu)
			<a href="$profilelink/$!showu.id/#stripstr($!showu.fullname)" title="$!showu.fullname [$!showu.reputation]">
				<img src="#profilepic($!showu true)" width="40" height="40" alt="Profile picture"/>
			</a>
		#else
			<img src="#profilepic($!showu true)" width="40" height="40" alt="Profile picture"/>
		#end
	</div>
#end
####################################
#macro(inactivepersonbox $showname $showclass)
	<div class="userbox media pas inlineblock">
		#set($isFBid = $showname.matches("^\d+$"))
		<div class="img mrm center">
			#if($isFBid)
				<img src="http://graph.facebook.com/$!{showname}/picture?type=square" width="50" height="50" alt="Profile picture"/>
			#else
				<img src="http://www.gravatar.com/avatar/?size=50&amp;d=mm&amp;r=pg" width="50" height="50" alt="Profile picture"/>
			#end
		</div>
		<div class="bd">
			<div class="smallText">
				#if($isFBid)
					<span class="fb-name">$!showname</span>
				#else
					$!showname
				#end
			</div>
			<span class="lightgray smallText">$!lang.get("invited")</span>
			
			#if(($authenticated && $authUser.reputation >= 20) || !$authenticated)
				<div>
					<a href="$classlink/p/$showclass.id/thisisme/${daoutils.urlEncode($!showname)}?thisisme=${daoutils.urlEncode($!showname)}" title="This is me!" class="button-tiny rounded3">$!lang.get("profile.thisisme")</a>
				</div>
			#end
		</div>
	</div>
#end
####################################
#macro(personlink $showu)
	<span>
		#if($showu.groups && !$showu.groups.isEmpty())
			#if($showu.isModerator())
				#if($showu.isAdmin())
					<span class="pictos" title="Scoold developer">b</span>
				#end
				<span class="pictos" title="$!lang.get('mod')">S</span>
			#else
				<span class="pictos">U</span>
			#end
		#end
		#if($showu)
			#if($showu.fullname)
				#set($seopsuffix = "/#stripstr($!showu.fullname)" )
			#else
				#set($seopsuffix = "" )
			#end
			<a href="$profilelink/$!{showu.id}$!{seosuffix}" title="Go to profile">$!showu.fullname</a>
		#else
			$!lang.get("profile.deleted")
		#end
	</span>
#end
####################################
#macro(peoplepage $people)
	#foreach($showFriend in $people)
		#personbox($showFriend)
	#end
#end
####################################
#macro(messagebox $showmsg)
	#set($uri = $request.getAttribute("javax.servlet.forward.request_uri"))
	#if($showmsg.isread) #set($gclass = "" ) #else #set($gclass = "lightbluebg" ) #end
	<div class="whitebox clearfix $gclass">
		<table>
			<tbody>
				<tr>
					<td class="prm">
						#tinypersonbox($showmsg.author)
					</td>
					<td class="p95"><span class="lightgray right">#formatdate($showmsg.timestamp "")</span> $!showmsg.body</td>
					<td class="pll">
						<a href="${uri}?delete=$showmsg.id" title="Delete" class="button-tiny rounded3 delete-message">
							<span class="pictos red">*</span> 
						</a>
					</td>
				</tr>
			</tbody>
		</table>
	</div>
#end
####################################
#macro(messagespage $messages )
	#foreach($showmsg in $messages)
		#messagebox($showmsg)
	#end
#end
####################################
#macro(commentbox $showcomment)
	#set($thisuri = $request.getAttribute('javax.servlet.forward.request_uri'))
	#if($request.getParameter('javax.servlet.forward.query_string'))
		#set($thisuri = "$!{thisuri}?$!request.getAttribute('javax.servlet.forward.query_string')")
	#end
	#if($thisuri.contains("?"))	#set($amp = "&amp;") #else #set($amp = "?") #end
	
	#if($showcomment == "")	#set($hide = "hide") #else #set($hide = "clearfix")	#end
	<div class="commentbox pas $hide">
		#if($showcomment.hidden)
			#set($hidden = "hide")
			<span>$!lang.get("comments.hidden") &nbsp;</span>
			<a href="#" title="$!lang.get('comments.show')" class="show-comment">$!lang.get("comments.show")</a>
		#else
			#set($hidden = "noclass")
		#end

		<div class="$hidden">
			<div class="left">
				<span class="lightgray pictos">w</span>
				#set($commentAuthor = {'fullname': $!showcomment.author, 'id': $showcomment.userid})
				<span class="comment-author">#personlink($commentAuthor):</span>&nbsp;
				<span class="comment-text">$!showcomment.comment</span>
			</div>
			<div class="inlineblock right max-width-100">
				<span class="comment-timestamp mrs"><span class="pictos">t</span> #formatdate($showcomment.timestamp '')</span>
				#votebox($showcomment "mrs")
				#if($showcomment == "")
					#getreportlink($showcomment "$commentlink/$!showcomment.id" "button-tiny rounded3 notext")
					<a href="${thisuri}" title="$!lang.get('delete')" class="red delete-comment pictos">D</a>
				#elseif($authenticated && ($showcomment.userid == $authUser.id || $request.isUserInRole("mod")))
					<a href="${thisuri}${amp}deletecomment=$!showcomment.id" title="$!lang.get('delete')" class="red delete-comment pictos">D</a>
				#else
					#getreportlink($showcomment "$commentlink/$!showcomment.id" "button-tiny rounded3 notext")
				#end
			</div>
		</div>
	</div>
#end
####################################
#macro(commentspage $comments)
	#foreach($comment in $comments)
		#commentbox($comment)
	#end
	#commentbox("") ## empty box to be cloned
#end
####################################
#macro(commentspagepreview $comments $count)
	#if($comments)
		#if($comments.size() > $count)
			#set($countmo = $count - 1 )
			#foreach($c in [0..$countmo])
				#commentbox($comments.get($c))
			#end

			#if($comments.size() > $count)
				<a href="#" class="more-comments-btn button-tiny rounded3">$!lang.get("more")</a>
				<div class="hide">
					#set($countmo = $comments.size() - 1 )
					#foreach($c in [$count..$countmo])
						#commentbox($comments.get($c))
					#end
				</div>
			#end
		#else
			#foreach($comment in $comments)
				#commentbox($comment)
			#end
		#end
	#end
	#commentbox("") ## empty box to be cloned
#end
####################################
#macro(drawerbox $showvideo)
	<div class="drawerbox mvl pbl">
		<div class="right">
			#if($authenticated && ($showvideo.userid == $authUser.id || $request.isUserInRole("mod")))
				<a href="${uri}/?remove=$!{showvideo.id}&amp;parentid=$!{showvideo.parentid}" title="Remove" class="delvideo button-small rounded3 red"><span class="pictos">*</span></a>
			#else
				#getreportlink($showvideo "$medialink/$!showvideo.id" "button-tiny rounded3")
			#end
		</div>
		
		#set($oembedclass = "oembed-box" )
		
		#set($uri = $request.getAttribute("javax.servlet.forward.request_uri"))
		<h2>
			#if($showvideo.type && !$showvideo.type.equalsIgnoreCase("unknown"))
				<span class="pictos">
					#if($showvideo.type.equalsIgnoreCase("video")) V
					#elseif($showvideo.type.equalsIgnoreCase("rich")) m
					#else j #set($oembedclass = "" )
					#end
				</span>
			#end
			#if($showvideo.title)
				<a href="$!showvideo.link" title="$!showvideo.title" class="extlink">$showvideo.title</a>
			#end
		</h2>

		#if($showvideo.type && $showvideo.type.equalsIgnoreCase("photo"))
			#set($embedlink = $showvideo.url)
		#else
			#set($embedlink = $showvideo.link)
		#end

		#if($showvideo.thumburl)
			<a href="$!embedlink" title="$!showvideo.title" class="extlink $!oembedclass">
				<img src="$!showvideo.thumburl" alt="$!showvideo.title" />
			</a>
		#else
			#set($w = ($showvideo.width * 30) / 100)
			#set($h = ($showvideo.height * 30) / 100)
			
			<a href="$!embedlink" title="$!showvideo.title" class="oembed-box extlink">
				<img width="$w" height="$h" src="$!showvideo.url" alt="$!showvideo.title" />
			</a>
		#end
		#if($showvideo.description)
			<p id="$showvideo.id" class="drawer-description editable">$showvideo.description</p>
		#end
	</div>
#end
####################################
#macro(drawerpage $drawer)
	#foreach($item in $drawer)
		#drawerbox($item)
	#end
#end
####################################
#macro(mediabox $showmedia )
	#if($showmedia.isImage())
		#thumbbox($showmedia "")
	#else
		#drawerbox($showmedia)
	#end
#end
####################################
#macro(getreportlink $reportable $link $clazz)
	#if($reportable)
		#set($requri = $request.getAttribute("javax.servlet.forward.request_uri"))
		#set($href = "${requri}?getreportform=true&amp;parentid=$!reportable.id&amp;parentid=$!reportable.id&amp;classname=$!reportable.class.getSimpleName()")
		#if(!$link.isEmpty())
			#set($encodedLink = $daoutils.urlEncode($link))
			#set($href = "${href}&amp;link=$encodedLink")
		#end
		#if($reportable.parentid && !$reportable.parentid.isEmpty())
			#set($href = "${href}&amp;grandparentid=$reportable.parentid")
		#end
		#if($clazz.contains("notext")) #set($showtxt = "" ) #else #set($showtxt = " $!lang.get('report')") #end
		<a href="$!{href}" title="Report a problem" class="trigger-report $!clazz"><span class="pictos">^</span>$showtxt</a>
	#end
#end
####################################
#macro(reportspage $reports )
	#foreach($report in $reports)
		#reportbox($report)
	#end
#end
####################################
#macro(reportbox $showreport )
	<div class="reportbox whitebox clearfix">
		<div class="mediumText lightgray mbm">
			$!lang.get("reports.$!{showreport.classname.toLowerCase()}"):
			$!lang.get("reports.$!{showreport.type.toLowerCase()}")
			<span class="right"><span class="pictos">t</span>#formatdate($!showreport.timestamp "")</span>
		</div>
		#if($showreport.closed)
			#set($hide = "" )
		#else
			#set($hide = "hide" )
		#end

		<div class="pictos left mrl hugeText green $hide">3</div>
		<div class="right">
			<a href="$showreport.link" class="button-medium rounded3"><span class="pictos">E</span> $!lang.get("open")</a>
			#if(!$showreport.closed)
				<a href="#" class="button-medium rounded3 close-report" title="Close report"><span class="pictos">3</span> $!lang.get("close")</a>
			#else
				<a href="$reportslink/close/$!showreport.id" title="Reopen report" class="button-medium rounded3"><span class="pictos">1</span> $!lang.get("reopen")</a>
			#end
			#if($request.isUserInRole("admin"))
				<a href="$reportslink/delete/$showreport.id" title="Delete" class="button-medium rounded3 red delete-report"><span class="pictos">*</span> $!lang.get("delete")</a>
			#end
		</div>
		<div class="clearfix">
			<strong> <span class="pictos">U</span>
				#if($showreport.userid && $showreport.userid > 0)
					<a href="$profilelink/$!showreport.userid" title="Go to profile">$!showreport.author:</a>
				#else
					<span>$!showreport.author:</span>
				#end
			</strong>
			#if($showreport.description && !$showreport.description.isEmpty())
				<span>$showreport.description</span>
			#end
			#if($showreport.solution && !$showreport.solution.isEmpty())
				#set($hide = "" )
			#else
				#set($hide = "hide" )
			#end
			<p class="report-solution $hide"><span class="pictos lightgray" title="$!lang.get('reports.actionstaken')">i</span> <span>$showreport.solution</span></p>
		</div>

		<div class="hide report-solution-box p100 mtm">
			<form method="post" class="report-solution-form" action="$reportslink/close/$!showreport.id">
				<fieldset>
					#sectoken(false)
					<textarea name="solution" cols="10" rows="1" class="nicebox p100 hintbox">$!lang.get("reports.actionstaken")...</textarea>
					<input class="report-solution-btn right" type="submit" value="$!lang.get('save') &amp; $!lang.get('close')" class="button rounded3"/>
				</fieldset>
			</form>
		</div>
	</div>
#end
####################################
#macro(questionspage $posts )
	#foreach($post in $posts)
		#questionbox($post)
	#end
#end
####################################
#macro(questionbox $showpost )
	#set($actionlink = "#getpostlink($showpost false true)")
	#set($actionlink2 = "#getpostlink($showpost true true)")

	<div class="questionbox whitebox clearfix">
		<div class="right mlm center max-width-100">
			#set($author = $showpost.author)
			#tinypersonbox($author)
			<div class="smallText">
				<span class="pictos">t</span>
				#formatdate($showpost.timestamp "")
			</div>
			#if(!$authenticated || ($authenticated && $showpost.userid != $authUser.id))
				#getreportlink($showpost "$questionlink/$!showpost.id" "button-tiny rounded3 notext")
			#end
		</div>
		<div class="media">
			#set($votes = $showpost.votes)
			#set($viewcount = $showpost.viewcount)
			#set($answercount = $showpost.answercount)

			#if(!$votes) #set($votes = 0) #end
			#if(!$viewcount) #set($viewcount = 0) #end
			#if(!$answercount) #set($answercount = 0) #end
			
			<div class="img">
				#if($showpost.answerid) #set($bgclass = "lightbluebg" ) #else #set($bgclass = "" ) #end
				<div class="qstatsbox mrl pas rounded5 center $!bgclass">
					<div class="largeText" title="$!lang.get('votes')">$!daoutils.abbreviateInt($!votes, 0)</div>
					<div class="line">
						<div class="unit size1of2" title="$!lang.get('answers.title')">$daoutils.abbreviateInt($!answercount, 0)</div>
						<div class="unit size1of2 lastUnit" title="$!lang.get('posts.views')">$daoutils.abbreviateInt($!viewcount, 0)</div>
					</div>
				</div>
			</div>
			<div class="bd">
				#if($showpost.deleteme)
					<span class="pictos red" title="$!lang.get('posts.marked')">#</span>
				#end
				<a href="$!actionlink/$showpost.id/#stripstr($!showpost.title)" class="mediumText">$!showpost.title</a>
				
				#set($bodyHtml = $daoutils.markdownToHtml($showpost.body))
				#set($showBody = $daoutils.stripHtml($bodyHtml) )
				<div>$!daoutils.abbreviate($showBody, 160)</div>
				<div>#tagsbox($showpost.tags $actionlink2)</div>
			</div>
		</div>
	</div>
#end
####################################
#macro(answerspage $answers $parentpost)
	#foreach($answer in $answers)
		#postbox($answer $parentpost)
	#end
#end
####################################
#macro(compactanswerspage $answers)
	#foreach($answer in $answers)
		#answerbox($answer)
	#end
#end
####################################
#macro(answerbox $showpost )
	<div class="questionbox whitebox clearfix max-width-100">
		<div class="right p">			
			<span class="pictos">t</span> #formatdate($showpost.timestamp "")
		</div>
		<div class="p100">
			#set($votes = $showpost.votes)
			#if(!$votes) #set($votes = 0) #end

			<span class="p10 reputationbox phs mediumText rounded3 mrl">$!votes</span>
			<span class="p70">
				<a href="$questionlink/$showpost.parentid#post-$!showpost.id" title="View answer">
					#$!daoutils.abbreviate($showpost.body, 100).replaceAll('\s', ' ')
				</a>
			</span>
		</div>
	</div>
#end
####################################
#macro(postbox $showpost $parentpost)
	#if($showpost.isReply())	#set($boxclass = "whitebox") #else #set($boxclass = "" ) #end
	
	#set($actionlink = "#getpostlink($showpost false true)")
	#set($actionlink2 = "#getpostlink($showpost true true)")
	
	<div class="p100 postbox $boxclass">
		#if($showpost.isBlackboard())
			<h2 class="inline">$!lang.get("blackboard.title")</h2> &nbsp;
			#set($divposclass = "right" )
		#else
			#set($divposclass = "mvm" )
		#end
		<div class="$!divposclass">
			
			#if($canEdit)
				<a href="#" title="Edit" class="editlink button-tiny rounded3"><span class="pictos">W</span> $!lang.get("edit")</a>
			#end

			#if($canComment && !$showpost.isBlackboard())
				<a href="#" class="next-div-toggle button-tiny rounded3" title="Add a comment"><span class="pictos">w</span> $!lang.get("comments.write")</a>
			#end
			
			#if($showpost.lasteditby)
				<a href="$!postlink/$showpost.id/revisions" title="Revision history" class="button-tiny rounded3"><span class="pictos">l</span> $!lang.get("revisions.title")</a>
			#end
			
			#if(!$showpost.isBlackboard())
				#if($showpost.deleteme)
					<a href="$!actionlink/$showpost.id/undelete" class="post-refresh button-tiny rounded3" title="Undelete"><span class="pictos">1</span> $!lang.get("undelete")</a>
				#elseif($isMine || $request.isUserInRole("mod"))
					<a href="$!actionlink/$showpost.id/delete" class="post-refresh-ask button-tiny rounded3" title="Delete"><span class="pictos">*</span> $!lang.get("delete")</a>
				#end
			#end

			#if($request.isUserInRole("mod") && $showpost.isQuestion())
				#if($showPost.isClosed())
					<a href="$!actionlink/$showpost.id/close" title="Reopen" class="post-refresh button-tiny rounded3"><span class="pictos">)</span> $!lang.get("reopen")</a>
				#else
					<a href="$!actionlink/$showpost.id/close" title="Close" class="post-refresh-ask button-tiny rounded3"><span class="pictos">(</span> $!lang.get("close")</a>
				#end
			#end

			#if($request.isUserInRole("admin") && !$showpost.isBlackboard())
				<a href="${adminlink}?delete=post&amp;id=$showpost.id" title="Delete" class="button-tiny rounded3 red"><span class="pictos">*</span> $!lang.get("delete")</a>
			#end

			#if(!$showpost.isBlackboard() && (!$authenticated || ($authenticated && $showpost.userid != $authUser.id)))
				#getreportlink($showpost "$questionlink/$!showpost.id" "button-tiny rounded3")
			#end

			#if($canComment && !$showpost.isBlackboard())
				#newcommentform($showpost.id true "$questionlink/$showpost.id")
			#end
		</div>

		#if(!$showpost.isBlackboard())
			<div class="line lightgraybg prs plm pts rounded5">
				<div class="unit size1of2">
					#votebox($showpost "hugeText mtm mrl")
					#if(!$showpost.isBlackboard())
						<span class="right mtm">
							#set($approvedAnswer = $showpost.id.equals($parentpost.answerid) )
							#if($approvedAnswer)
								#set($onclass = "green")
								#set($picon = "2")
							#else
								#set($onclass = "")
								#set($picon = "3")
							#end
							#if($authenticated && $showpost.isReply() && $parentpost.userid.equals($authUser.id))
								<a href="$!actionlink/$parentpost.id/approve/$showpost.id" class="megaText pictos approve-answer nodecoration $!onclass" title="Approve answer">$picon</a>
							#elseif($approvedAnswer)
								<span class="pictos megaText green">$picon</span>
							#end
						</span>
					#end
				</div>
				<div class="unit size1of2 lastUnit r">
					#set($author = $showpost.author)
					#smallpersonbox($author)
				</div>
			</div>
		#end

		#if(!$showpost.isBlackboard())
			#set($postviewid = "post-$!showpost.id" )
			#set($bbclazz = "mbm" )
		#else
			#set($postviewid = "blackboard" )
			#set($bbclazz = "rounded3 pas" )
		#end
		<div id="$postviewid" class="viewbox $bbclazz">
			<div class="mbl pas">
				#set($bodyHtml = $daoutils.markdownToHtml($showpost.body))
				$!{bodyHtml}

				#if($showpost.isBlackboard() && (!$showpost.body || $showpost.body.trim().isEmpty()))
					<div class="center mtl mediumText">$!lang.get("class.blankboard")</div>
				#end
				
				#if($showpost.tags && !$showpost.tags.isEmpty())
					<div class="mtm">#tagsbox($showpost.tags $actionlink2)</div>
				#end
			</div>

			#if($showpost.lasteditby || !$showpost.isBlackboard())
				<div class="line">
					<div class="unit size1of3">
						#if(!$showpost.isBlackboard())
							<span class="pictos">p</span>
							<strong>$!lang.get("posts.posted")</strong>
							<span class="pictos">t</span> #formatdate($showpost.timestamp "")
						#end
					</div>
					<div class="unit size2of3 lastUnit r">
						#if($showpost.lasteditby)
							<span class="pictos">W</span>
							<strong>
								<a href="$postlink/$showpost.id/revisions" title="Revision history">$!lang.get("posts.editby")</a>
							</strong>
							#personlink($showpost.lastEditor) <span class="pictos">t</span> #formatdate($showpost.lastactivity "")
						#end
					</div>
				</div>
			#end
		</div>
		#if($canEdit)
			<div class="editbox lightgraybg rounded5 pam hide">
				#set($form = $showpost.editForm)
				#if($form)
					#set($editLink = $request.getAttribute("javax.servlet.forward.request_uri"))
					<form method="post" id="$form.id" action="$editLink">
						#if ($form.error)
							#getmessagebox("errorBox" $form.error false)
						#end
						<fieldset>
							#sectoken(false)
							#renderSpecialFields($form)
							${form.fields.timer}
							<input type="hidden" name="editpostid" value="$showpost.id"/>
							<div class="hide">Leave blank:</div>${form.fields.additional}
							#createformfield(${form.fields.body} "hidelabel edit-post nicebox p99")
							<div class="edit-preview"></div>
							#if($showpost.isQuestion())
								#createformfield(${form.fields.tags} "tagbox nicebox p99")
							#end

							<div class="center mtl">
								${form.fields.editbtn}
								<input type="button" value="$!lang.get('close')" class="button rounded3 canceledit"/>
							</div>
						</fieldset>
					</form>
				#end
			</div>
		#end

		<div class="comments post-comments">
			#if($showpost.commentcount > 0)
				#paginate($showpost.pagenum.longValue() "\#commentspagepreview(\$showpost.comments 2)" $showpost.commentcount "getcomments=true&amp;parentid=$showpost.id" "pageless")
			#end
		</div>
	</div>
#end
####################################
#macro(revisionspage $revisions $canrestore $showpost)
	#if($revisions && !$revisions.isEmpty())
		#set($lastIndex = $revisions.size() - 1)
		#set($lastrev = $revisions.get($lastIndex))

		#if($revisions.size() == 1)
			#revisionbox($lastrev $lastrev $canrestore $showpost)
		#else

			#if($revisions.size() > $MAX_ITEMS_PER_PAGE)
				#set($lastrev = $revisions.remove($lastIndex))
			#end

			#foreach($revision in $revisions)
				#if($velocityCount < $revisions.size())
					#set($prevrev = $revisions.get($velocityCount))
				#else
					#set($prevrev = $lastrev)
				#end

				#revisionbox($revision $prevrev $canrestore $showpost)
			#end
		#end
	#end
#end
####################################
#macro(revisionbox $showrev $showorigrev $canrestore $showpost)
	#set($actionlink = "#getpostlink($showpost false true)")
	#set($actionlink2 = "#getpostlink($showpost true true)")
	<div class="whitebox revisionbox">
		<div class="line lightgraybg rounded3 pas">
			<div class="unit size1of3">
				#set($author = $showrev.getAuthor())
				#smallpersonbox($author)
			</div>
			<div class="unit size1of3 center">
				<span class="lightgray mediumText">#if($showrev.original) $!lang.get("original") #else  #$!showrev.id #end </span>
			</div>
			<div class="unit size1of3 lastUnit r">
				<div class="lightgray mediumText">
					<span class="mrs"><span class="pictos">t</span> #formatdate($showrev.timestamp "")</span>
				</div>
				<div class="mts">
					
					#if($showpost.revisionid == $showrev.id)
						<span class="pictos green largeText" title="$!lang.get('revisions.current')">2</span>
					#elseif($canrestore || $request.isUserInRole("mod"))
						<a href="$!actionlink/$showrev.parentid/restore/$!showrev.id" class="post-refresh-ask button-small rounded3" title="Restore">
							<span class="pictos">1</span> $!lang.get("restore")
						</a>
					#end
				</div>
			</div>
		</div>
		<div>
			#if($showrev.title)
				<h3 class="newrev">$showrev.title</h3>
				#if($showorigrev.title)
					<span class="hide oldrev">$!showorigrev.title</span>
				#end
			#end
			#if($showrev.body)
				#set($revHtml = $daoutils.markdownToHtml($showrev.body))
				#set($showRevBody = $daoutils.stripHtml($revHtml) )
				<div class="newrev mtl">$!showRevBody</div>
				#if($showorigrev.body)
					#set($origHtml = $daoutils.markdownToHtml($showorigrev.body))
					#set($showOrigBody = $daoutils.stripHtml($origHtml) )
					<span class="hide oldrev">$!showOrigBody</span>
				#end
			#end
			#if($showrev.tags)
				<div class="newrev tagsdiff mtm">
					#tagsbox($showrev.tags "")
				</div>
				#if($showorigrev.tags)
					<span class="hide oldrev">#tagsbox($!showorigrev.tags "")</span>
				#end
			#end
		</div>
	</div>
	<br/>
#end
###################################
#macro(translationspage $translations $approvedmap)
	#foreach($trans in $translations)
		#set($approved = $approvedmap.containsKey($trans.key) && $approvedmap.get($trans.key).equals($trans.id))
		#translationbox($trans $approved)
	#end
#end
###################################
#macro(translationbox $showtrans $approved)
	#set($timestamp = "#formatdate($showtrans.timestamp '')")
	#set($thisuri = $request.getAttribute('javax.servlet.forward.request_uri'))

	<div class="translationbox media">
		<div class="img mrm">
			#if($request.isUserInRole("admin") && true)
				#if($approved)
					#set($onclass = "green")
					#set($picon = "2")
				#else
					#set($onclass = "")
					#set($picon = "3")
				#end
				<a href="${thisuri}?approve=$showtrans.id" class="approve-translation largeText pictos nodecoration $!onclass" title="Approve">$picon</a>				
				&nbsp;
			#end
			#votebox($showtrans "mediumText")
		</div>
		<div class="bd pts">
			<div class="trans-value inlineblock">$!showtrans.value</div>
			<div class="right">
				#set($translAuthor = $!showtrans.author)
				#personlink($translAuthor)
				<span class="trans-timestamp"><span class="pictos">t</span> $!timestamp</span>
				#if($authenticated && ($showtrans.userid == $authUser.id || $request.isUserInRole("admin")))
					<a href="${thisuri}?delete=$!showtrans.id" title="Delete" class="delete-translation red button-tiny rounded3"><span class="pictos">*</span></a>
				#else
					#getreportlink($showtrans "$translatelink/$!showtrans.id" "button-tiny rounded3 notext")
				#end
			</div>
		</div>
	</div>
#end
###################################
#macro(langbox $showLangKey $showLangName $progress  )
	#if($showLangKey.equals($currentLocale.language)) #set($selclass = "selected-lang rounded5") #else #set($selclass = "") #end
	<div class="inlineblock mrl mbm center langbox rounded5 $selclass">
		<div class="mediumText mbs">
			#if($selclass == "")
				<form action="$languageslink" method="post">
					<fieldset>
						#sectoken(false)
						<input type="hidden" name="setlocale" value="$!showLangKey"/>
						<input type="submit" class="button-link capitalize" value="$showLangName"/>
					</fieldset>
				</form>
			#else
				<span class="capitalize">$!{showLangName}</span>
			#end
		</div>
		<div>
			#if($progress != 100)
				<span class="reputationbox rounded3 phs" title="$!{progress}%">$!{progress}%</span>
			#else
				<span class="reputationbox rounded3 phs" title="100%"><span class="pictos">3</span></span>
			#end
			
			#if(!$showLangKey.equals("en"))
				<a href="$translatelink/$!showLangKey" title="$!{lang.get('translate.translate')}" class="button-tiny rounded3">$!lang.get("translate.translate")</a>
			#end
		</div>
	</div>
#end
###################################
#macro(badgebox $showbadge $num)
	#set($badgeinfo = $!lang.get("about.badges.$showbadge") )
	<span class="badge phs mas rounded5 inlineblock" title="$!badgeinfo">
		<span class="pictos">S</span> 
		#if($num && $num > 1)
			$!lang.get("$showbadge") <sup>$num</sup>
		#else
			$!lang.get("$showbadge")
		#end
	</span>
#end
###################################
#macro(showcount $param )
	#if($param > 1)
		<span class="lightbluebg rounded3 phs">$!param</span>
	#end
#end
################# OPENID MACROS #####################
#macro(getopenidbtns)
	#set($lproviders = {
		'google': {'name': 'Google', 'url': 'https://www.google.com/accounts/o8/id'},
		'yahoo': {'name': 'Yahoo', 'url': 'http://yahoo.com/'},
		'aol': {'name': 'AOL', 'url': 'http://openid.aol.com/(username)'}
	})
	#set($sproviders = {
		'myopenid': {'name': 'MyOpenID','url': 'http://(username).myopenid.com/'},
		'livejournal': {'name': 'LiveJournal','url': 'http://(username).livejournal.com/'},
		'wordpress': {'name': 'Wordpress.com','url': 'http://(username).wordpress.com/'},
		'blogger': {'name': 'Blogger','url': 'http://(username).blogspot.com/'},
		'symantec': {'name': 'Symantec','url': 'http://(username).pip.verisignlabs.com/'},
		'flickr': {'name': 'Flickr','url': 'http://flickr.com/photos/(username)'},
		'myid': {'name': 'myID','url': 'http://(username).myid.net'},
		'claimid': {'name': 'ClaimID','url': 'http://claimid.com/(username)'},
		'vidoop': {'name': 'myVidoop','url': 'http://(username).myvidoop.com/'}
	})
	<div class="clearfix p100">
		<input id="openid_identifier" type="text" name="openid_identifier" value="http://" class="nicebox openidbox p90 vertcenter hide"/>
		#foreach($provider in $lproviders.entrySet())
			<a id="oids-$!provider.key" title="$!provider.value.name" href="$provider.value.url" class="openidbtn-large rounded5">$!provider.value.label</a>
		#end
		<br/>
		#foreach($provider in $sproviders.entrySet())
			<a id="oids-$!provider.key" title="$!provider.value.name" href="$provider.value.url" class="openidbtn-small rounded5">$!provider.value.label</a>
		#end
	</div>
#end
################# MISC MACROS #####################
#macro(votebox $votable $sizeClass)
	#if($votable == "")
		#set($id = "")
		#set($classname = "comment")
	#else
		#set($id = $!votable.id)
		#set($classname = $votable.class.simpleName.toLowerCase())
	#end
	#if($authenticated) #set($linkclass = "votelink") #else #set($linkclass = "") #end
	#if($votable.votes)	#set($votes = $votable.votes) #else #set($votes = 0) #end

	<div class="votebox inlineblock $sizeClass">
		#if($votable && $authenticated && $votable.userid.longValue() == $authUser.id.longValue())
			<span class="pictos downvote lightgray" title="Vote down">-</span>
			<span class="votecount">$!votes</span>
			<span class="pictos upvote lightgray" title="Vote up">+</span>			
		#else
			<a href="$votedownlink/$!classname/$!id" class="pictos downvote $linkclass" title="Vote down">-</a>
			<span class="votecount">$!votes</span>
			<a href="$voteuplink/$!classname/$!id" class="pictos upvote $linkclass" title="Vote up">+</a>
		#end
	</div>
#end
#####################################
#macro(createformfield $field $class)
#if($field)
	#if(!$class.isEmpty())  $field.setAttribute("class", $class)  #end
	#if ($field.error) #set($hideme = "") #else  #set($hideme = "hide")  #end
	#if($class.contains("hintbox"))
		$field.setValue($!field.label)
	#elseif(!$class.contains("hidelabel") && !$field.isHidden())
		#if($field.label && !$field.label.isEmpty()) <label class="blocklabel">$!{field.label}: </label>#end
	#end
	<span class="error $!hideme">$!{field.error}</span>
	$!{field}
	#end
#end
#####################################
#macro(formatdate $date $format)
	#if($date && !$format.trim().isEmpty() && $format != "slim")
		$daoutils.formatDate($date, $format, $currentLocale)
	#elseif($date)
		#set($delta = $daoutils.timestamp() - $date)
		#set($approxtime = $daoutils.humanTime.approximately($delta))
		#if(!$approxtime || $approxtime.isEmpty()) #set($approxtime = "1s") #end
		#set($lastindx = $approxtime.length() - 1 )
		#set($suffix = $approxtime.substring($lastindx))
		#set($approx = $approxtime.substring(0, $lastindx))		
		#set($sufstr = "humantime.$suffix" )
		#if($format == "slim")
			$!daoutils.formatMessage($!lang.get($!sufstr), $!approx) [$daoutils.formatDate($date, 'dd MMMM yyyy, HH:mm', $currentLocale)]
		#else
			<span title="$daoutils.formatDate($date, 'dd MMMM yyyy, HH:mm', $currentLocale)">
				$!daoutils.formatMessage($!lang.get($!sufstr), $!approx)
			</span>
		#end
	#end
#end
#####################################
#macro(reportform $classname $parentid $grandparentid $parentid $link)
	<form method="post" class="create-report-form" action="$context/?report=true">
		<fieldset>
			#sectoken(false)
			<legend><span class="pictos">^</span> $!lang.get("reportproblem")</legend>
			<label class="blocklabel">$!lang.get("reports.category")</label>
			<select class="nicebox p100" name="type">
				#foreach($type in $reportTypes)
					#if($type.name() == "OTHER")
					<option selected="selected" value="$!type.name()">$!lang.get("reports.$type.toString()")</option>
					#else
					<option value="$!type.name()">$!lang.get("reports.$type.toString()")</option>
					#end
				#end
			</select>
			<label class="blocklabel">$!lang.get("reports.description")</label>
			<textarea class="p98 nicebox" cols="15" rows="5" name="description"></textarea>
			<input type="hidden" name="parentid" value="$!parentid"/>
			<input type="hidden" name="parentid" value="$!parentid"/>
			<input type="hidden" name="classname" value="$!classname"/>
			#if($grandparentid && $grandparentid != "")
				<input type="hidden" name="grandparentid" value="$!grandparentid"/>
			#end
			#if($link && !$link.isEmpty())
				<input type="hidden" name="link" value="$!link"/>
			#end
			<div class="center mtm">
				<input id="sendreport-btn" type="submit" value="$!lang.get('send')" class="button rounded3 mrm"/>
				<input type="button" value="$!lang.get('close')" class="button rounded3 jqmClose"/>
			</div>
		</fieldset>
	</form>
#end
#####################################
#macro(getmessagebox $class $text $hidden)
#if($hidden) #set($hideclass = "hide") #else #set($hideclass = "") #end
	<div class="messagebox $class $hideclass" title="$!lang.get('click2close')">
		<div class="msg center">  #if($text == "") &nbsp; #else $text #end  </div>
	</div>
#end
#####################################
#macro(getpostlink $p $plural $noid)
	#set($link = "" )
	#if($noid) #set($pid = "" ) #else #set($pid = "/${p.id}/#stripstr($!p.title)") #end
	#if($p)
		#if($p.isQuestion())
			#if($plural) #set($link = "$questionslink" ) #else #set($link = "$questionlink${pid}" ) #end
		#elseif($p.isFeedback())
			#if($plural) #set($link = "$feedbacklink" ) #else #set($link = "$feedbacklink${pid}" ) #end
		#elseif($p.isGrouppost())
			#if($plural) #set($link = "${grouplink}/${p.parentid}" ) #else #set($link = "$grouppostlink${pid}" ) #end
		#elseif($p.isReply())
			#set($parentp = $daoutils.getDaoInstance("post").read($p.parentid) )
			#if($parentp) #set($link = "#getpostlink($parentp $plural $noid)" ) #end
		#elseif($p.isBlackboard())
			#if($noid) #set($cpid = "" ) #else #set($cpid = "/${p.parentid}" ) #end
			#if($plural) #set($link = "$classeslink" ) #else #set($link = "${classlink}${cpid}" ) #end
		#end
	#end
	$!{link}
#end
#####################################
#macro(ajaxloading $hide)
	#if($hide) #set($hidden = "hide") #else #set($hidden = "") #end
	<img src="$imageslink/indicator.gif" alt="loading" class="ajaxwait vertcenter $!hidden"/>
#end
#####################################
#macro(profilepic $user $thumb)
	#set($picurl = "http://www.gravatar.com/avatar/?d=mm")
	#if($user)
		#if($thumb)
			#if($user.isFacebookUser())
				#set($picurl = "http://graph.facebook.com/$!{user.identifier}/picture?type=square")
			#else
				#set($picurl = "http://www.gravatar.com/avatar/$!{daoutils.MD5($user.email)}?size=50&amp;d=mm&amp;r=pg")
			#end
		#else
			#if($user.isFacebookUser())
				#set($picurl = "http://graph.facebook.com/$!{user.identifier}/picture?type=large")
			#else
				#set($picurl = "http://www.gravatar.com/avatar/$!{daoutils.MD5($user.email)}?size=200&amp;d=mm&amp;r=pg")
			#end
		#end
	#end
	$!picurl
#end
#####################################
#macro(infostrip )
	#if($request.getParameter("success"))
		#set($infoStripClass = "successBox" )
	#elseif($request.getParameter("error"))
		#set($infoStripClass = "errorBox" )
	#else
		#set($infoStripClass = "infoBox" )
	#end
	
	#if($infoStripMsg.isEmpty() && !$request.getParameter("code") && $badgelist.isEmpty())
		#set($hideInfoStrip = "hide")
	#else
		#set($hideInfoStrip = "")
	#end
	
	#if($infoStripMsg == "intro" && !$request.getParameter("code"))
		#set($hideInfoStrip = "introBox" )
		#set($infoStripMsg = "$!lang.get('about.intro') <a href='$aboutlink'>$!lang.get('learnmore')</a>" )
		#set($infoStripClass = "" )
	#elseif($systemMessage && !$systemMessage.isEmpty())
		#set($hideInfoStrip = "sysmsgBox" )
		#set($infoStripMsg = $!systemMessage )
		#set($infoStripClass = "infoBox blue" )
	#end
	
	<noscript>
		<div class="infostrip errorBox pvm center">
			<span class="pictos ico errorBoxIcon $!he">!</span> $!{lang.get("nojavascript")}
		</div>
	</noscript>
	<div class="infostrip center pvm $hideInfoStrip $infoStripClass" title="$!lang.get('close')">
		#set($hs = "hide" ) #set($he = "hide" ) #set($hi = "hide" )
		#if($infoStripClass.contains("successBox"))
			#set($hs = "" ) 
		#elseif($infoStripClass.contains("errorBox"))
			 #set($he = "" )
		#elseif($infoStripClass.contains("infoBox"))
			#set($hi = "" )
		#end
		<span class="pictos ico successBoxIcon $!hs">2</span>
		<span class="pictos ico errorBoxIcon $!he">!</span>
		<span class="pictos ico infoBoxIcon  $!hi">i</span>
		
		<span class="infostrip-msg">
			#if(!$badgelist.isEmpty())
				#if($badgelist.size() > 1) $!lang.get("newbadges") #else $!lang.get("newbadge") #end
				&nbsp;
				#foreach($badge in $badgelist)
					#badgebox($badge 0)
				#end					
			#elseif($request.getParameter("code"))
				$!lang.get("msgcode.${request.getParameter('code')}")
			#else
				$!infoStripMsg
			#end
		</span>
	</div>
#end
#####################################
#macro(stripstr $str )$!daoutils.spacesToDashes($str)#end
#####################################
#macro(identifierbox $showid $canDetach $index)
	<span>
		#if($showid.startsWith("http"))
			<span class="openid-icon-small" title="OpenID">&nbsp;</span>&nbsp;
			<tt>$showid</tt>
		#else
			<span class="facebook-icon-small" title="Facebook">&nbsp;</span>&nbsp;
			<span id="fb-name">Facebook #$!showid</span>
		#end
		#if($canDetach)
			<a href="${settingslink}?detachid=$index" title="Remove" class="delopenid nodecoration red"><span class="pictos">D</span></a>
		#end
	</span>
#end
#####################################
#macro(usertitlebadge $showu)
	#if($showu.isModerator())
		#if($showu.isAdmin())
			<span class="pictos" title="Scoold developer">b</span>
		#end
		<span class="pictos" title="$!lang.get('mod')">S</span>
	#end
	#set($tbadge = $showu.titleBadge )
	#if($tbadge) #set($tbadgestr = $!lang.get("$tbadge") ) #else #set($tbadgestr = "" ) #end
	$!tbadgestr
#end
#####################################
#macro(setsortbyselection $paramMap $defkey )
	#set($sbparam = $request.getParameter("sortby")) #set($sbclazz = "button-tiny-selected" )
	#if($sbparam && !$sbparam.isEmpty()) #set($paramMap[$sbparam] = $sbclazz) #else #set($paramMap[$defkey] = $sbclazz) #end
#end
#####################################
#macro(signinbox $attachOnly )
	<div class="line">
		<div class="unit size1of2 pal rightborder">
			#if(!$attachOnly)
				<h2 title="Signin with your account">$!{lang.get('signin.openid')}&nbsp;
					<a href="#" class="pictos next-div-toggle" title="About OpenID">?</a>
				</h2>
				<div class="hide mtm pvm">
					$!lang.get("signin.openid.text") <a href="http://openid.net" class="extlink">$!lang.get("learnmore")</a>
				</div>
			#end			
			#if($attachOnly) #set($oidurl = "attach_openid") #else #set($oidurl = "openid_auth") #end
			<form method="post" action="$context/$oidurl" class="mtl">
				<fieldset>
					#sectoken(false)					
					<div id="openid-btns">#getopenidbtns()</div>
					<div class="center mtl">
						#if($attachOnly)
							#set($submitlabel = $!lang.get("add"))
						#else
							#set($submitlabel = $!lang.get("signin.title"))
						#end						
						<input type="submit" value="$submitlabel" class="button rounded3"/>
					</div>
				</fieldset>
			</form>
		</div>

		#if($attachOnly) #set($fbbtnclass = "fb-attach-btn") #else #set($fbbtnclass = "fb-login-btn") #end
		<div class="unit size1of2 lastUnit pal center">
			#if(!$attachOnly)
				<h2 id="fb-login">$!lang.get("signin.facebook")</h2>
			#end
			<div class="mvl ptl">
				<a id="$fbbtnclass" href="#" class="rounded3 mediumText nodecoration">$!lang.get("signin.title")</a>
			</div>
		</div>
	</div>
#end
#####################################
#macro(sectoken $bare)
	#if($authenticated)
		#set($authToken = $daoutils.getStateParam($AUTH_USER, $request, $request.response, $USE_SESSIONS) )
		#set($authSalt = "$authUser.authstamp" )
		#set($secToken = $daoutils.MD5($authToken.concat($SEPARATOR).concat($authSalt)) )
		#if($bare && $bare == true)$secToken#else
			<input type="hidden" name="stoken" value="$!secToken"/>
			<input type="hidden" name="pepper" value="$!authSalt"/>
		#end		
	#end
#end	
#####################################
#macro(adplaceholders )
<!--	<script type="text/javascript">
		var AdBrite_Title_Color = '5397CC';
		var AdBrite_Text_Color = '444444';
		var AdBrite_Background_Color = 'FFFFFF';
		var AdBrite_Border_Color = 'FFFFFF';
		var AdBrite_URL_Color = '5397CC';
		try{var AdBrite_Iframe=window.top!=window.self?2:1;var AdBrite_Referrer=document.referrer==''?document.location:document.referrer;AdBrite_Referrer=encodeURIComponent(AdBrite_Referrer);}catch(e){var AdBrite_Iframe='';var AdBrite_Referrer='';}
	</script>
	<script type="text/javascript">document.write(String.fromCharCode(60,83,67,82,73,80,84));document.write(' src="http://ads.adbrite.com/mb/text_group.php?sid=2026165&zs=3138305f313530&ifr='+AdBrite_Iframe+'&ref='+AdBrite_Referrer+'" type="text/javascript">');document.write(String.fromCharCode(60,47,83,67,82,73,80,84,62));</script>
	<script type="text/javascript">
		var AdBrite_Title_Color = '5397CC';
		var AdBrite_Text_Color = '444444';
		var AdBrite_Background_Color = 'FFFFFF';
		var AdBrite_Border_Color = 'FFFFFF';
		var AdBrite_URL_Color = '5397CC';
		try{var AdBrite_Iframe=window.top!=window.self?2:1;var AdBrite_Referrer=document.referrer==''?document.location:document.referrer;AdBrite_Referrer=encodeURIComponent(AdBrite_Referrer);}catch(e){var AdBrite_Iframe='';var AdBrite_Referrer='';}
	</script>
	<script type="text/javascript">document.write(String.fromCharCode(60,83,67,82,73,80,84));document.write(' src="http://ads.adbrite.com/mb/text_group.php?sid=2026171&zs=3136305f363030&ifr='+AdBrite_Iframe+'&ref='+AdBrite_Referrer+'" type="text/javascript">');document.write(String.fromCharCode(60,47,83,67,82,73,80,84,62));</script>-->
			
<!--		<img src="http://placehold.it/220x125" width="220" height="125" alt="ad"/>
		<img src="http://placehold.it/220x125" width="220" height="125" alt="ad"/>
		<img src="http://placehold.it/220x420" width="220" height="420" alt="ad"/>-->

	<a href="http://www.adbrite.com/mb/commerce/purchase_form.php?opid=2026171&amp;afsid=1">
		<img src="http://placehold.it/180x150/efefef/444444&amp;text=Your+ad+here" width="180" height="150" alt="ad" class="rounded3"/>
	</a>
	<a href="http://www.adbrite.com/mb/commerce/purchase_form.php?opid=2026171&amp;afsid=1">
		<img src="http://placehold.it/160x600/efefef/444444&amp;text=Your+ad+here" width="160" height="600" alt="ad" class="rounded3"/>
	</a>
#end
################# END MACROS ###################################################
#if($isAjaxRequest || false)
	################# PAGINATION AJAX REQUESTS #################
	#if($request.getParameter("page"))
		#if(!$pageMacroCode || $pageMacroCode.trim().isEmpty())
			#set($pageMacroCode = "$!request.getParameter('pageMacroCode')" )	
		#end
		#evaluate($pageMacroCode)
		#if($pagenum.longValue() > 10000) #set($pnext = $pagenum.intValue()) #else #set($pnext = $pagenum.intValue() + 1) #end
		<span class="$!pnext"/>
		#stop
	#end
    ################ AUTOCOMPLETE AJAX REQUESTS ################
    #if($request.getParameter("q") && $request.getParameter("find"))

		#set($q = $request.getParameter("q"))
        #if($request.getParameter("find") == "locations")
            #foreach($location in $daoutils.readLocationForKeyword($q.trim()))
                ${location.name}, ${location.countryName}| ${location.adminName1} |${location.geoNameId}
            #end
			#stop
        #elseif($request.getParameter("find") == "schools")
            #foreach($showschool in $daoutils.findByKeyword("school", $q.trim(), 7))
                ${showschool.name}|${showschool.location}|${showschool.id}
            #end
			#stop
		#elseif($request.getParameter("find") == "classes")
            #foreach($showclass in $daoutils.findByKeyword("classunit", $q.trim(), 7))
				${showclass.identifier}|$!lang.get("profile.myclasses.gradyear"): ${showclass.gradyear} |${showclass.id}
            #end
			#stop
		#elseif($request.getParameter("find") == "tags")
            #foreach($showtag in $daoutils.findTags($q.trim(), 7))
				$!{showtag.tag}| |${showtag.id}
            #end
			#stop
		#elseif($request.getParameter("find") == "people")
            #foreach($showuser in $daoutils.findUser($q.trim(), 7))
				$!{showuser.fullname}| |${showuser.id}
            #end
			#stop
        #end
	#end
    ################# SPECIAL AJAX REQUESTS #################
    #if($request.getParameter("getaboutviewcode"))
        #showaboutview()
		#stop

	#elseif($request.getParameter("getschoolaboutviewcode"))
        #schoolaboutview()
		#stop

	#elseif($request.getParameter("getmyschoolscode"))
		#myschoolspage($schoollist)
		#stop

	#elseif($request.getParameter("newmessage"))
		#if($request.getParameter("toname") && $request.getParameter("toid"))
			#newmessageform($request.getParameterValues("toname") $request.getParameterValues("toid"))
		#else
			#newmessageform([] [])
		#end
		#stop

	#elseif($request.getParameter("getcommenthtmlcode"))
		#commentbox($!newcomment)
		#stop

	#elseif($request.getParameter("getallcommentscode"))
		#if($request.getParameter("page"))
			#set($Int = 0)
			#set($page = $Int.parseInt($request.getParameter("page")))
		#else
			#set($page = $pagenum.longValue())
		#end
		#if($commentslist && $itemcount.longValue() && $commentslist.size() > 0)
			#paginate($page "\#commentspage(\$commentslist)" $itemcount.longValue() "" "pageless" )
		#end
		#stop

	#elseif($request.getParameter("getmediahtmlcode"))
		#mediabox($lastMedia)
		#stop
	
	#elseif($request.getParameter("getreportform"))
		#if($request.getParameter("parentid")  && $request.getParameter("parentid") && $request.getParameter("classname"))
			#reportform($request.getParameter("classname") 
				$request.getParameter("parentid")
				$!request.getParameter("grandparentid")
				$request.getParameter("parentid")
				$!request.getParameter("link"))
		#end
		#stop

	#elseif($request.getParameter("voteup") || $request.getParameter("votedown"))
		$!voteresult
		#stop

	#elseif($request.getParameter("addlabel"))
		$!labeladded
		#stop

	#elseif($request.getParameter("importphotos"))
		$!importsuccess
		#stop

	#elseif($request.getParameter("gettranslationhtmlcode"))
		#translationbox($!newtranslation)
		#stop

	#elseif($request.getParameter("getsmallpersonbox"))
		#if($showAjaxUser)
			#smallpersonbox($showAjaxUser)
		#end
		#stop
		
	#end
	#stop
	
#elseif($request.getAttribute('javax.servlet.forward.request_uri') == "/feed.xml")
	#stop
#end
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="$currentLocale.language">
    <head>
		#basichead($!DESCRIPTION $!KEYWORDS)
		<link href="$context/opensearch.xml" title="$APPNAME" type="application/opensearchdescription+xml" rel="search"/>
		<link href="$context/feed.xml" rel="alternate" type="application/atom+xml" title="New questions feed" />
		#if($authenticated && $authUser.favtags && !$authUser.favtags.isEmpty())
			#set($feedkey = $daoutils.MD5("${authUser.id}${FEED_KEY_SALT}"))
			<link href="$context/feed.xml?userid=$authUser.id&amp;key=$feedkey" rel="alternate" type="application/atom+xml" title="Selected questions feed"/>
		#end
		<script type="text/javascript" src="$scriptslink/head${minsuffix}.js"></script>
		<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>
		#if($includeGMapsScripts && $includeGMapsScripts == true)
		<script type="text/javascript" src="http://maps.google.com/maps/api/js?v=3.6&amp;sensor=false&amp;key=ABQIAAAAA1422Oq_eBM65GXKc1EKmBQpUxXMgUUkS03NA9iiHvjrwMZsNBTcMwCDC6IzCtvARyV866T9rtg38w"></script>
		#end
		#if(!$IN_PRODUCTION)
			<style type="text/css">
				@font-face {
					font-family: 'PictosRegular';
					src: url('$!context/styles/pictos-web.eot');
					src:  local('☺'), 
						url('$!context/styles/pictos-web.woff') format('woff'),
						url('$!context/styles/pictos-web.ttf') format('truetype'),
						url('$!context/styles/pictos-web-webfont.svg#webfontIyfZbseF') format('svg');
					font-weight: normal;
					font-style: normal;
				}
			</style>
		#end
	</head>
    <body>
		#if($includeFBscripts)
			<div id="fb-root"></div>
			<script type="text/javascript">
				window.fbAsyncInit = function() {
					FB.init({appId: '$FB_APP_ID', status: true, cookie: true, xfbml: false, oauth: true});
				};
				// Load the SDK Asynchronously
				(function(d){
					var js, id = 'facebook-jssdk'; if (d.getElementById(id)) {return;}
					js = d.createElement('script'); js.id = id; js.async = true;
					js.src = "//connect.facebook.net/$fb_locale/all.js";
					d.getElementsByTagName('head')[0].appendChild(js);
				}(document));
			</script>
		#end
		<div class="report-dialog jqmWindow rounded5"> <div class="center">#ajaxloading(false) </div></div>
		<div id="main" class="clearfix">
			#infostrip()
			<div id="header" class="ptm">
				<div class="container">
					<div class="left">
						<a id="logo" href="$!prefix">$APPNAME</a> 
						#if($IN_BETA) &nbsp;<code class="smallText" title="Beta">&beta;</code> #end
					</div>
					<div id="topnav" class="right mtl">
					#if($authenticated)
						#if($isFBconnected)
							<span class="facebook-icon-small" title="You are signed via Facebook">&nbsp;</span>
						#else
							<span class="openid-icon-small" title="You are signed in with OpenID">&nbsp;</span>
						#end
						#if($authUser.fullname)
							<a href="$profilelink/$authUser.id/#stripstr($authUser.fullname)" title="My profile">$!{authUser.fullname}</a>
						#end
						|
						#if($authUser.countNewMessages() > 0) 
							<span class="notificationbox rounded5">$authUser.countNewMessages()</span>
						#else 
							<span class="pictos">M</span>
						#end
						<a href="$messageslink" title="Messages">$!{lang.get('messages.title')}</a> |
						<span class="pictos gray">y</span> <a href="$settingslink" title="Settings">$!{lang.get('settings.title')}</a> |
						#if($request.isUserInRole("mod"))
							#if($authUser.countNewReports() > 0) 
								<span class="notificationbox rounded5">$authUser.countNewReports()</span>
							#else
								<span class="pictos">^</span>
							#end
							<a href="$reportslink" title="Reports">$!lang.get("reports.title")</a> |
						#end
						#if($isFBconnected) #set($logoutid = "fb-logout" ) #else #set($logoutid = "logoutbtn" )	#end
						<span class="pictos">K</span>
						<form method="post" action="$signoutlink" class="inline">
							<fieldset class="inline">
								#sectoken(false)
								<input id="signout-btn" type="submit" value="$!lang.get('signout')" class="bold button-link"/>
							</fieldset>
						</form>
					#else
						#set($thisuri = $request.getAttribute('javax.servlet.forward.request_uri'))
						#if($request.getParameter('javax.servlet.forward.query_string'))
							#set($thisuri = "$!{thisuri}?$!request.getAttribute('javax.servlet.forward.query_string')")
						#end
						#if($thisuri && $thisuri.startsWith($context))
							#set($thisuri = $thisuri.replaceFirst($context, ""))
						#end
						<a href="$context/p$!{thisuri}" title="Sign in" class="button-small rounded3"><span class="pictos">K</span> $!lang.get("signin.title")</a>
					#end
					</div>
				</div>
			</div>
			<div id="nav" class="mediumText">
				<div class="container">
					<div class="line">
						<div class="unit size2of3">
							<ul id="nav-list" class="left">
								<li><a href="$questionslink" title="Questions" class="nicebtn rounded3 $!questionsSelected">$!lang.get("questions.title")</a></li>
								<li><a href="$peoplelink" title="People" class="nicebtn rounded3 $!peopleSelected">$!lang.get("people.title")</a></li>
								<li><a href="$schoolslink" title="Schools" class="nicebtn rounded3 $!schoolsSelected">$!lang.get("schools.title")</a></li>
								<li><a href="$classeslink" title="Classes" class="nicebtn rounded3 $!classesSelected">$!lang.get("classes.title")</a></li>
								#if($authenticated)
									<li><a href="$groupslink" title="Groups" class="nicebtn rounded3 $!groupsSelected">$!lang.get("groups.title")</a></li>
								#end
							</ul>
						</div>
						<div class="unit size1of3 lastUnit">
							<div id="search" class="rounded3 prs right">
								<form method="get" id="search-form" action="$searchlink">
									<fieldset>
										#if($request.getParameter("q"))
											#set($showSearchValue = $!request.getParameter('q'))
											#set($hintbox = "noclass" )
										#else
											#set($showSearchValue = $!lang.get('search.search'))
											#set($hintbox = "hintbox" )
										#end
										<input type="submit" class="pictos search-btn right" value="s"/>
										<input id="search-box" type="text" class="$!hintbox" name="q" value="$showSearchValue"/>
									</fieldset>
								</form>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="container">
                <div id="content" class="clearfix">
					#parse($path)
				</div>
			</div>
        </div>
		
        <div id="footer" class="mtl">
            <div class="container">

				<div class="line">
					<div class="unit size4of5">
						<div class="clearfix">
							<a id="cc-icon" rel="license" class="extlink left mrm mbl pts" href="http://creativecommons.org/licenses/by-sa/3.0/">
							</a>
							<div>$daoutils.formatMessage($!lang.get("license"), '<a class="extlink" href="http://creativecommons.org/licenses/by-sa/3.0/">Creative Commons</a>')</div>
							<ul class="inline-list">
								<li><a href="$aboutlink" title="About">$!{lang.get('about.title')}</a> &bull;</li>
								<li><a href="$feedbacklink" title="Feedback">$!{lang.get('feedback.title')}</a> &bull;</li>
								<li><a href="http://blog.scoold.com" title="Blog" class="extlink">$!{lang.get('blog.title')}</a> &bull;</li>								
								<li><a href="$privacylink" title="Privacy">$!{lang.get('privacy.title')}</a> &bull;</li>
								<li><a href="$termslink" title="Terms">$!{lang.get('terms.title')}</a></li>								
							</ul>
						</div>
					</div>

					<div class="unit size1of5 lastUnit r">
						<span class="mediumText">
							<span class="pictos">G</span>
							<a href="$!languageslink" title="Switch to a different language" class="capitalize">
								$showCurrentLocale
							</a>
						</span>
					</div>
				</div>
            </div>
        </div>
		
		#set($sectoken = "#sectoken(true)")
		#set($sectoken = $sectoken.trim())
		
		#set($jslang = ["areyousure","messages.sent","messages.to","profile.contacts.added","alumnus", "teacher", 
			"student","profile.status.txt","profile.status.update","profile.status.txt","class.chat.userin",
			"class.chat.userout","class.chat.connection.error","class.chat.polling.error","class.chat.reconnect.error",
			"more","posts.unloadconfirm","signup.form.error.required","signup.form.error.email","maxlength","minlength",
			"tags.toomany","close", "save", "clickedit","profile.drawer.embedly.notanimage","profile.drawer.embedly.photosaved","invalidyear"])
			
		
		<script type="text/javascript">
			/* <![CDATA[ */
			function loadScripts(scriptslink, minsuffix) {
				head.js ({jquery:		"http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.7.1.min.js" },
					{validate:		"http://ajax.aspnetcdn.com/ajax/jquery.validate/1.9/jquery.validate.min.js" },
					{modal:			scriptslink + "/jquery.modal" + minsuffix + ".js" },
					{jeditable:		scriptslink + "/jquery.jeditable" + minsuffix + ".js" },
					{autocomplete:	scriptslink + "/jquery.autocomplete" + minsuffix + ".js" },
					{oembed:		scriptslink + "/jquery.oembed" + minsuffix + ".js" },
					{markitup:		scriptslink + "/jquery.markitup" + minsuffix + ".js" },
					{chatclient:	scriptslink + "/chatclient" + minsuffix + ".js" },
					{miuicons:		scriptslink + "/miu.set.markdown" + minsuffix + ".js" },
					{showdown:		scriptslink + "/showdown" + minsuffix + ".js" },
					{diff:			scriptslink + "/diff_match_patch" + minsuffix + ".js" },
					{scoold:		scriptslink + "/scoold" + minsuffix + ".js" });
			}
			
			var lang = {#foreach($!langkey in $jslang)"$!langkey":"$daoutils.escapeJavascript($!lang.get($!langkey))"#if($velocityCount < $jslang.size()),#end #end},
				sessiontimeout = $!SESSION_TIMEOUT_SEC;
			#if($authenticated)
				var stoken = "$sectoken", pepper = "$authUser.authstamp";
			#end
			loadScripts("$!{scriptslink}", "$!{minsuffix}");
			/* ]]> */
		</script>
    </body>
</html> 